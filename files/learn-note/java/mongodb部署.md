# Mongodb部署
## 可复制集
可复制集是跨多个Mongodb服务器（节点）分布和维护数据的方法。Mongodb可以把数据从一个节点复制到其他节点并在修改时进行同步，
集群中的节点配置为自动同步的数据；旧方法叫主从复制，3.0以后推荐使用可复制集。
### 为什么用可复制集
* 避免数据丢失，保障数据安全，提高系统安全性；（最少3节点，最大50节点）
* 自动化灾备机制，主节点宕机后通过选举产生新主机，提高系统健壮性；（7个选举节点上限）
* 读写分离，负载均衡，提高系统性能；
* 生产环境推荐的部署模式。
### MongoDB复制集特点
* 主是唯一的，但不是固定的。整个复制集中只有一个主节点，其余为从节点或选举节点，但是因为MongoDB具有自动容灾功能，所以当唯一的主节点发生宕机时会从从节点的Priority参数不为0当中选举一个为主节点‘
* 由大多数据原则保证数据的一致性。即MongoDB复制集内投票成员（参数vote不为0的其他成员具有投票权，且只能投票一次）数量为n，则大多数为n/2+1，当复制集内存活成员数不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务。
* 从库无法写入。只有主节点可以写，主节点和从节点都可以读。
* 相对传统主从结构，复制集可自动容灾。
### 架构及原理
一般为应用程序、主节点、从节点，只在主节点上写数据。
#### oplog
保存操作记录、时间戳（oplog是盖子集合，大小可调整，默认是所在硬盘的5%）
#### 数据同步
从节点与主节点之间保持长轮询，从节点查询本机oplog最新时间戳，查询主节点oplog晚于此时间戳的所有文档，加载这些文档并根据log执行写操作
#### 阻塞复制
与writerconcern相关，不需要同步到从节点的策略（如acknowledge unacknowledged、w1），数据同步都是异步的，其余情况是同步的（如majority、j:true）
#### 心跳机制
成员之间每2s进行一次心跳检测（ping），发现故障后进行选举或故障转移
#### 选举制度
主节点故障后，其余节点根据优先级和bully算法选举新的主节点，在选出主节点之前，集群服务是只读的。
### 可复制集搭建过程
1. 安装好3个以上节点的mongodb；
2. 配置mongodb.conf，增加复制集相关配置：
replication:replSetName:configRS//集群名称
replication:oplogSizeMB:50//oplog集合大小
3. 在primary节点切换到admin库上运行可复制集的初始化命令（复制集初始化在主节点上执行，IP禁止使用localhost）  
ns.initiate();ns.add()//添加从节点
4. 在每个节点运行rs.status()或isMaster()命令查看复制集状态；
5. 只能在主节点查询数据，若想在从节点查询到数据运行rs.slaveOK()。
## 分片集群
分片是把大型数据集进行分区成更小的可管理的片，这些数据片分散到不同的mongodb节点，这些节点组成分片集群。  
mongodb分片集群推荐的模式是分片集合，它是一种基于分片键的逻辑对文档进行分组，分片键的选择对分片非常重要，分片键一旦确定mongodb对数据的分片对应用是透明的。
* 请求分流：通过路由节点将请求分发到对应的分片和块上；
* 数据分流：内部提供平衡器保证数据的均匀分布，数据均匀分布是请求平均分布的前提；
* 块的拆分：3.4版本块的最大容量是54MB或10w数据，当达到阈值，触发块的拆分，块一分为二；
* 块的迁移：为保证数据在分片节点服务器平均分布，块会在节点之间迁移，一般相差8个节点触发。
### 分片集群架构组件
#### 分片
在集群中唯一存储数据的位置，可以是单个mongodb服务器也可以是可复制集，每个分区上存储部分数据；生产环境推荐使用可复制集；
#### mongos路由
由于分片只存储部分数据，需要mongos路由将读写操作路由到对应的分区上；mongos提供了单点连接集群的方式，轻量级、非持久化所以通常mongos和应用部署在同一服务器上；
#### 配置服务器
存储集群的元数据，元数据包括：数据库、集合、分片的范围位置以及跨片数据分割和迁移的日志信息；mongos启动时会从配置服务器读取元数据信息在内存中；配置服务器最低3台。
### 注意点
* 热点：某些分片键会导致所有的读或者写请求都操作在单个块或者分片上，导致单个服务器压力增大。自增长的分片键容易导致写热点问题；  
* 不可分割数据块：过于粗粒度的分片键可能导致许多文档使用相同的分片键，这意味着这些文档不能被分割为多个数据块，限制mongodb均匀分布数据的能力；  
* 查询障碍：分片键与查询没有关联，造成糟糕的查询性能；
### 建议
* 不适用自增长字段作为分片键；
* 不使用粗粒度分片键；
* 不适用完全随机的分片键；
* 使用与查询相关的字段作为分片键而且包含唯一字段；
* 索引对于分区同样重要，每个分片集合要有同样的索引。分片键默认成为索引，分片集合只允许在id和分片键上创建唯一索引。
### 实践经验
* 尽量选取稳定版本的64位，Linux；
* 数据模式设计：单文档优先，将关联关系作为内嵌文档或者内嵌数组；
* 避免使用skip跳过大量数据，通过查询条件尽量缩小数据范围或者利用上一次查询结果查询下一页；
* 避免单独使用不适合索引的查询符（$ne $nin $where）；
* 选择合适的写入策略；
* 生产环境建议打开profile便于优化系统性能；
* 生产环境建议打开auth模式保证安全；
* 不要将mongodb与其他服务部署在同一台机器上；
* 单机必须开启journal日志，推荐多机器使用复制集，并开启读写分离。
