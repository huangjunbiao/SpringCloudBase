# 分布式事务
分布式事务跟数据库事务有点不一样，它是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统节点上。分布式事务指的就是分布式系统中的事务，它的存在就是为了保证不同数据库节点的数据一致性。
## 事务定义
事务提供一种机制将一个活动涉及的所有操作纳入到一个不可分割的执行单元，组成事务的所有操作只有在所有操作均能正常执行的情况下才能提交，只要其中任一操作执行失败，都将导致整个事务的回滚。
## 数据库本地事务
### ACID
**A 原子性（Atomicity）**  
一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚到事务开始的状态，就像这个事务从未执行过一样。  
**C 一致性（Consistency）**  
事务的一致性是指在一个事务执行之前和执行之后数据库都必须处于一致性状态。如果事务成功的完成，那么系统中所有变化将正确的应用，系统处于有效状态。如果事务中出现错误，那么系统中的所有变化将会自动的回滚，系统返回到原始状态。  
**I 隔离性（Isolation）**  
是指在并发环境中，当不同的事务同时操作相同的数据时，每个事务都有各自的完整数据空间。由并发事务所作的修改必须与任何其他并发事务所做的修改隔离。事务查看数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。  
**D 持久性（Durability）**  
指的是只要事务成功结束，它对数据库所做的更新就必须永久保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。  
## 分布式事务基础
CAP理论和BASE理论  
CAP理论：
1. 一致性（Consistency）：一致性是指数据在多个副本之间能否保存一致的特性。例如一个数据在某个分区节点更新之后，在其他分区节点读出来的数据也是更新之后的数据；
2. 可用性（Availability）：是指某个系统提供的服务必须一直处于可用状态，对于用户的每一个请求总是能够在有限时间内返回结果；
3. 分区容错性（Partition tolerance）：分布式系统在任何网络分区故障的时候仍然需要能够保证对外提供满足一致性和可用性的服务。  
> 一个分布式系统中CAP理论只能同时满足其中的两点  

BASE理论：是对CAP中AP的一个扩展，对于业务系统考虑牺牲一致性换取系统的可用性和分区容错性。（Basically available、Soft state、Eventually consistent）
* 基本可用是指通过支持局部故障而不是系统全局故障来实现；
* Soft state：表示状态可以有一段时间不同步；
* 最终一致：最终数据一致就可以，而不是实时一致。
## 分布式事务解决方案
* 2PC：两阶段提交，事务的提交分为两个阶段：准备阶段和提交执行阶段；
* TCC（try confirm cancel）：采用了补偿机制，核心思想是：针对每个操作都要注册一个与其对应的确认和补偿（撤销）操作；
* 本地消息表：核心思想是将分布式事务拆分为本地事务进行处理；
* 最大努力通知：可以采用MQ的ack机制；
* Sega事务：核心思想是将长事务拆分为多个本地短事务，由Sega事务协调器协调，如果正常结束那就正常完成，如果某个步骤失败那就根据相反顺序一次调用补偿操作。

目前业界本地消息表方案比较多，核心思想是将分布式事务拆分为本地事务进行处理。  
对于消息发送方：
* 首先需要有一个消息表，记录着消息状态相关的信息；
* 业务数据和消息表在同一个数据库，即要保证它俩在同一个本地事务；
* 在本地事务处理完业务数据和写消息表操作后，通过写消息到MQ消息队列；
* 消息会发送到消息消费方，如果发送失败则进行重试。

消息消费方：
* 处理消息队列中的消息，完成自身业务逻辑；
* 此时如果本地事务处理成功，则表明已经处理成功了；
* 如果本地事务处理失败，那么就会重试执行；
* 如果是业务上面的失败，给消息生产方发一个业务补偿消息，通知进行回滚操作。
> 生产方和消费方定时扫描本地消息表，把还没有处理完成的消息或者失败的消息再发送一遍。
