# MongoDB
## mongodb复制集作用
主要意义在于实现服务高可用
### 实现依赖于两方面功能
* 数据写入时数据迅速复制到另一个独立节点上；
* 在接收写入的节点发生故障时自动选举出一个新的替代节点。
### 实现高可用同时，复制集实现几个其他附加作用
* 数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟；
* 读写分离：不同类型的压力分别在不同节点上执行；
* 异地容灾：在数据中心故障时快速切换到异地。
## 复制集结构
一个典型的复制集由3个以上具有投票权的节点组成
* 一个主节点（PRIMARY）：接受写入操作和选举时投票；
* 两个（或多个）从节点（SECONDARY）：复制主节点上的新数据和选举时投票；
* 不推荐使用Arbiter(投票节点，即不做数据存储只用来投票)
## 数据如何复制
* 当一个修改操作，无论是插入、更新或删除，到达主节点时，它对数据的操作将被记录下来（经过一些必要的转换），这些记录成为oplog；
* 从节点通过在主节点上打开一个tailable游标不断获取新进入主节点的oplog，并在自己的数据上回放，以此保持与主节点数据一致。
## 通过选举完成故障恢复
* 具有投票权的节点之间两两互相发送心跳（默认2s）；
* 当5次心跳未收到时判断为节点失联；
* 如果失联的是主节点，从节点会发起选举，选出新的主节点；
* 如果失联的是从节点则不会产生新的选举；
* 选举基于 RAFT一致性算法 实现，选举成功的必要条件是大多数投票节点存活；
* 复制集最多可以有50个节点，但具有投票权的节点最多7个
### 影响选举的因素
* 整个集群必须有大多数节点存活；
* 被选举为主节点的节点必须：能够与多数节点建立连接、具有较新的oplog、具有较高的优先级。
### 复制集节点具有以下常见选项
* 是否具有投票权（v 参数）：有则参与投票
* 优先级（priority 参数）：优先级越高的节点越优先成为主节点。优先级为0的节点无法成为主节点
* 隐藏（hidden 参数）：复制数据，但对应用不可见。隐藏节点可以具有投票权，但优先级必须为0
* 延迟（slaveDelay 参数）：复制n秒之前的数据，保持与主节点的时间差
### 复制集注意事项
* 关于硬件：因为正常的复制集节点都有可能成为主节点，它们的地位是一样的，因此硬件配置上必须一致、为了保证节点不会同时宕机，各个节点使用的硬件必须具有独立性
* 关于软件：为了保证节点不会同时宕机，各个节点使用的硬件必须具有独立性
* 为了保证节点不会同时宕机，各个节点使用的硬件必须具有独立性
